(function(){function a(f,j,i,c,k,e){var d=new zkex.inp.Color();d.setRGB(j,i,c);var h=d.getHex();f.push('<span class="',k,'-color" data-color="',h,'" ','data-index="',e,'" style="background-color: ',h,';"></span>')}var b=zkex.inp.Colorpalette=zk.$extends(zk.Widget,{$init:function(c){this.$supers("$init",arguments);this._wgt=c._wgt;this._color=new zkex.inp.Color()},redraw:function(f){var m=this.$s(),l=this.uuid,h=zk.ie<11||zk.gecko?"a":"button",g,e,c,d=0;f.push('<div id="',l,'" class="',m,'">','<div id="',l,'-newcolor" class="',this.$s("newcolor"),'"></div>','<input id="',l,'-hex-inp" class="',this.$s("input"),'" type="text" size="7" maxlength="7"></input>');for(e=0;e<12;e++){for(c=0;c<3;c++){for(g=0;g<=5;g++){f.push(a(f,c*51+(e%2)*51*3,Math.floor(e/2)*51,g*51,m,d++))}}}for(g=0;g<16;g++){e=Math.floor((g+g*16)%256);f.push(a(f,e,e,e,m,d++))}f.push(a(f,255,255,255,m,d++),a(f,255,255,255,m,d++),"<",h,' id="',l,'-a" tabindex="-1" onclick="return false;" href="javascript:;" class="z-focus-a"></',h,"></div>")},onFloatUp:function(c){if(!zUtl.isAncestor(this,c.origin)){this._clearSelected({clearIndex:true})}else{if(!zUtl.isAncestor(this.parent,c.origin)){this._wgt.onHide()}}},bind_:function(){this.$supers(b,"bind_",arguments);this.domListen_(this.$n("btn"),"onClick","_doPopupPicker");zWatch.listen({onShow:this,onFloatUp:this,onHide:this})},unbind_:function(){this.domUnlisten_(this.$n("btn"),"onClick","_doPopupPicker");zWatch.unlisten({onShow:this,onFloatUp:this,onHide:this});this._selectedIndex=null;this.syncIndex=null;this.$supers(b,"unbind_",arguments)},onShow:function(){this.$n("newcolor").style.backgroundColor=this._color.getHex();this._focus(true)},onHide:function(){this._wgt.onHide()},setColor:function(c){this._color.setHex(c)},_doPopupPicker:function(c){var d=this._wgt;d.closePalette();d.openPicker();c.stop()},doMouseOver_:function(c){var d=c.domTarget;if(jq(d).hasClass(this.$s("color"))){this._clearSelected({clearIndex:true});this._doColorOver(d);this.syncIndex=true;c.stop()}this.$supers("doMouseOver_",arguments)},doMouseOut_:function(c){this._doColorOut(c.domTarget)},doClick_:function(c){var f=c.domTarget;if(jq(f).hasClass(this.$s("color"))){var d=this.$n("hex-inp");if(!d.value){d.value=jq(f).data("color")}var e=this._wgt;e.onChange(d.value);e.closePalette(true);jq(f).removeClass(this.$s("selected"));c.stop()}else{if(f==this.$n("hex-inp")){this._clearSelected({clearIndex:true})}else{this._focus()}}this.$supers("doClick_",arguments)},_doHexChange:function(){var e=this._wgt,c=this._color;c.setHex(this.$n("hex-inp").value);var d=c.getHex();this.$n("hex-inp").value=d;e.onChange(d);e.closePalette(true)},doKeyDown_:function(c){var h=c.keyCode,g=c.domTarget,e=this.$n("hex-inp");switch(h){case 48:case 96:case 49:case 97:case 50:case 98:case 51:case 99:case 52:case 100:case 53:case 101:case 54:case 102:case 55:case 103:case 56:case 104:case 57:case 105:case 46:case 8:break;case 37:case 38:case 39:case 40:if(g!=e){var f=h==37?-1:h==39?1:h==38?-18:h==40?18:0;this._shift(f);c.stop()}break;case 13:var d=this._selectedIndex;if(g==e||d||d==0||this._syncIndex()){this._doHexChange();return}default:if(g==e&&"ABCDEF".indexOf(String.fromCharCode(h))>=0){break}c.stop();return}},doKeyUp_:function(c){var d=c.keyCode;switch(d){case 37:case 38:case 39:case 40:if(c.domTarget!=this.$n("hex-inp")){c.stop()}return}},_focus:function(d){var c=this.$n("a");if(c){if(d){setTimeout(function(){zk(c).focus()})}else{zk(c).focus()}}},_shift:function(f){var c=jq(this.$n()).find("."+this.$s("color")),e=c.length,d=this._selectedIndex;if(d||d==0){d=d+f}else{if(this._syncIndex()){d=this._selectedIndex+f}else{d=0}}this._clearSelected();if(d<0){d=0}else{if(d>=e){d=e-1}}this._selectedIndex=d;this._doColorOver(c[d])},_syncIndex:function(){if(this.syncIndex){this.syncIndex=null;var c=jq(this.$n()).find("."+this.$s("selected"));if(c.length){this._selectedIndex=c.data("index");return true}}return false},_clearSelected:function(d){var c=this._selectedIndex;this.syncIndex=null;if(c||c==0){this._doColorOut(jq(this.$n()).find('[data-index="'+c+'"]'));if(d&&d.clearIndex){this._selectedIndex=null}}},_doColorOver:function(c){this.$n("hex-inp").value=this.$n("newcolor").style.backgroundColor=jq(c).data("color");jq(c).addClass(this.$s("selected"))},_doColorOut:function(c){jq(c).removeClass(this.$s("selected"))}})})();