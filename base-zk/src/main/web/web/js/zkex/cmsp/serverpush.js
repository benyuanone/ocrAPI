(function(){var c=zAu.shallIgnoreESC,a=0;zAu.shallIgnoreESC=function(){return c()||a>0};function b(){var j=this._req;try{if(j&&j.readyState==4){this._req=null;var i,f,h;if((i=j.getResponseHeader("ZK-Comet-Error"))=="Disabled"||i=="DesktopUnavailable"||(f=j.status)==404||f==405||f==410||(h=j.getResponseHeader("ZK-Error"))=="404"||h=="410"){h=zAu.getPushErrorURI(f==404||h=="404"?404:410);if(typeof h=="string"){zUtl.go(h)}this.stop()}else{if(f==200){this._nfail=0;if(j.getResponseHeader("ZK-Comet")=="echo"||i=="Hibernate"){zAu.cmd0.echo(this.desktop)}if(i!="Hibernate"){if((h=i=="Busy")){this._send();var g=this;setTimeout(function(){if(g.desktop){zAu.cmd0.echo(g.desktop)}},200)}else{this._asend(0)}}}else{if(f==502){this._send();var g=this;setTimeout(function(){zAu.cmd0.echo(g.desktop)},200)}else{this._retry(5000)}}}}}catch(k){this._retry(5000)}}function d(){this.stop()}zkex.cmsp.SPush=zk.$extends(zk.Object,{_nfail:0,start:function(f,e){++a;this.desktop=f;this.cometURI=e;this._asend(90)},stop:function(){--a;this._stopped=true;var e=this._req;if(e){this._req=null;try{if(typeof e.abort=="function"){e.abort()}}catch(f){}}},visibilityChanged:function(){if(document.hidden||document[zk.vendor_+"Hidden"]){try{var g=this._req=zAu.ajaxSettings.xhr(),f=this.desktop;g.open("POST",this.cometURI(f)+"&hibernate=true",true);g.setRequestHeader("Content-Type",zAu.ajaxSettings.contentType);g.send(null)}catch(h){}}else{this._stopped=false;this.start(this.desktop,this.cometURI)}},_send:function(){this._asending=false;var g=this._req=zAu.ajaxSettings.xhr(),f=this.desktop;try{g.onreadystatechange=this.proxy(b);g.onabort=this.proxy(d);g.open("POST",this.cometURI(f),true);g.setRequestHeader("Content-Type",zAu.ajaxSettings.contentType);g.send(null)}catch(h){this._req=null;this._asend(5000)}},_asend:function(e){if(!this._asending&&!this._stopped){this._asending=true;setTimeout(this.proxy(this._send),e)}},_retry:function(e){if(++this._nfail<10){this._asend(e)}else{this.stop()}}});zk.copy(zkex.cmsp,{start:function(e,g){var f=zk.Desktop.$(e);if(f._cmsp){f._cmsp.stop()}(f._cmsp=new zkex.cmsp.SPush()).start(f,this.cometURI);if(!g){jq(document).bind((document.hidden!==undefined?"":zk.vendor_)+"visibilitychange",f._cmsp.proxy(f._cmsp.visibilityChanged))}},stop:function(e){var f=zk.Desktop.$(e);if(f&&f._cmsp){jq(document).unbind((document.hidden!==undefined?"":zk.vendor_)+"visibilitychange",f._cmsp.proxy(f._cmsp.visibilityChanged));f._cmsp.stop();f._cmsp=null}},cometURI:function(e){return zk.ajaxURI("/comet?dtid="+e.id,{desktop:e,au:true})}})})();