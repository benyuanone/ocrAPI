(function(){function a(c){c._clearSelection();c._ppMaxHeight=c.fixDisplay=c._separatorCode=c._startOnSearching=c._chgSel=c.fixInputWidth=null}function b(c){if(!c._startOnSearching){c._startOnSearching=setTimeout(function(){if(c.$n("inp")){c._fireOnSearching(c.$n("inp").value)}c._startOnSearching=null},c._getSearchingInterval())}}zkmax.inp.Chosenbox=zk.$extends(zul.Widget,{$init:function(){this.$supers("$init",arguments);this._selItems=[];this._separatorCode=[];this._ppMaxHeight=350},setItems:(function(c,d){return function(e,f){var g=this[c];this[c]=e;if(g!==e||(f&&f.force)){this.__fname__=c.substring(1);d.apply(this,arguments);delete this.__fname__}return this}})("_items",(function(c){if(!this._renderByServer){this.setListContent()}})),getItems:_zkf$=function(){return this._items},isItems:_zkf$,setTabindex:(function(c,d){return function(e,f){var g=this[c];this[c]=e;if(g!==e||(f&&f.force)){this.__fname__=c.substring(1);d.apply(this,arguments);delete this.__fname__}return this}})("_tabindex",(function(c){var d=this.$n("inp");if(d){d.tabindex=c||""}})),getTabindex:_zkf$=function(){return this._tabindex},isTabindex:_zkf$,setSelectedIndex:(function(c,d){return function(e,f){var g=this[c];this[c]=e;if(g!==e||(f&&f.force)){this.__fname__=c.substring(1);d.apply(this,arguments);delete this.__fname__}return this}})("_selectedIndex",(function(c){var d,e;if(!this._renderByServer){this._clearSelection();if((e=this.$n("sel"))&&c>=0){d=jq(e).children();if(c<d.length){this._doSelect(d[c])}}}if(c==-1){this._fixEmptyMessage(true)}})),getSelectedIndex:_zkf$=function(){return this._selectedIndex},isSelectedIndex:_zkf$,setRenderByServer:(function(c,d){return function(e,f){var g=this[c];this[c]=e;if(g!==e||(f&&f.force)){this.__fname__=c.substring(1);d.apply(this,arguments);delete this.__fname__}return this}})("_renderByServer",(function(c){if(c&&this.$n()){this._clearListContent()}})),getRenderByServer:_zkf$=function(){return this._renderByServer},isRenderByServer:_zkf$,setDisabled:(function(c,d){return function(e,f){var g=this[c];this[c]=e;if(g!==e||(f&&f.force)){this.__fname__=c.substring(1);d.apply(this,arguments);delete this.__fname__}return this}})("_disabled",(function(c){var d=this.$n("inp");if(d){d.disabled=c?"disabled":""}d=this.$n();if(d){jq(d)[c?"addClass":"removeClass"](this.$s("disabled"))}})),getDisabled:_zkf$=function(){return this._disabled},isDisabled:_zkf$,setName:(function(c,d){return function(e,f){var g=this[c];this[c]=e;if(g!==e||(f&&f.force)){this.__fname__=c.substring(1);d.apply(this,arguments);delete this.__fname__}return this}})("_name",(function(c){var d=this.$n("inp");if(d){d.name=c}})),getName:_zkf$=function(){return this._name},isName:_zkf$,setEmptyMessage:(function(c){return function(d){this[c]=d;return this}})("_emptyMessage"),getEmptyMessage:_zkf$=function(){return this._emptyMessage},isEmptyMessage:_zkf$,setNoResultsText:(function(c){return function(d){this[c]=d;return this}})("_noResultsText"),getNoResultsText:_zkf$=function(){return this._noResultsText},isNoResultsText:_zkf$,setCreateMessage:(function(c){return function(d){this[c]=d;return this}})("_createMessage"),getCreateMessage:_zkf$=function(){return this._createMessage},isCreateMessage:_zkf$,setSeparator:(function(c,d){return function(e,f){var g=this[c];this[c]=e;if(g!==e||(f&&f.force)){this.__fname__=c.substring(1);d.apply(this,arguments);delete this.__fname__}return this}})("_separator",(function(c){var d=this._separatorCode;d.length=0;if(c.indexOf(",")!=-1){d.push(188)}if(c.indexOf(".")!=-1){d.push(190)}if(c.indexOf("/")!=-1){d.push(191)}if(c.indexOf(";")!=-1){d.push(zk.ie<11?186:59)}if(c.indexOf("'")!=-1){d.push(222)}if(c.indexOf("[")!=-1){d.push(219)}if(c.indexOf("]")!=-1){d.push(221)}if(c.indexOf("\\")!=-1){d.push(220)}if(c.indexOf("-")!=-1){d.push(zk.ie<11?189:109)}if(c.indexOf("=")!=-1){d.push(107)}})),getSeparator:_zkf$=function(){return this._separator},isSeparator:_zkf$,setCreatable:(function(c){return function(d){this[c]=d;return this}})("_creatable"),getCreatable:_zkf$=function(){return this._creatable},isCreatable:_zkf$,setOpen:(function(c){return function(d){this[c]=d;return this}})("_open"),getOpen:_zkf$=function(){return this._open},isOpen:_zkf$,setListContent:function(c){var g,d,e,f;if(g=this.$n("sel")){if(e=jq(this.$n("sel")).find("."+this.$s("option-hover"))[0]){f=e.innerHTML}d=[];this._renderItems(d,c);this._clearListContent();g.innerHTML=d.join("");if(f&&(e=this._getItemByValue(f))){this._hliteOpt(e,true)}this._startFixDisplay({hliteFirst:true,fromServer:true})}},_clearListContent:function(){if(this.$n()){this.$n("sel").innerHTML="";this.$n("empty").style.display="none"}},_renderItems:function(d,g){var f=$eval(g?g:this._items)||[];for(var e=0,c=f.length;e<c;e++){d.push('<div class="',this.$s("option"),'">',zUtl.encodeXML(f[e]),"</div>")}return d},setChgSel:function(k){if(k&&k.$equals(this._selItems)){return}this._clearSelection();var j,d;if(j=this.$n("sel")){d=jq(j).children();var f=$eval(k),c=this._renderByServer,g,h;for(var e=0;e<f.length;e++){h=f[e];if(g=this._getItemByValue(h)){this._doSelect(g)}else{this._selectItemDirectly(h)}}}else{this._chgSel=k}this._fixEmptyMessage(true)},bind_:function(){this.$supers(zkmax.inp.Chosenbox,"bind_",arguments);var e=this.$n(),d=this.$n("inp"),c;this.domListen_(d,"onFocus","doFocus_").domListen_(d,"onBlur","doBlur_");zWatch.listen({onFloatUp:this,onSize:this,onScroll:this});if(c=this._chgSel){this.setChgSel(c);this._chgSel=null}this._fixEmptyMessage(true);if(this._open&&!this.isDisabled()){this.setOpen(true)}},unbind_:function(){var c=this.$n("inp");this.domUnlisten_(c,"onFocus","doFocus_").domUnlisten_(c,"onBlur","doBlur_");zWatch.unlisten({onFloatUp:this,onSize:this,onScroll:this});this.setOpen(false);a(this);this.$supers(zkmax.inp.Chosenbox,"unbind_",arguments)},onSize:function(){this._fixInputWidth();this._fixWidth(this.$n())},_fixWidth:function(d){if(this._width){d.style.width=this._width}var c=this.$n("pp");c.style.width=zk(c).revisedWidth(d.offsetWidth)+"px"},doBlur_:function(c){jq(this.$n()).removeClass(this.$s("focus"));var d=this;setTimeout(function(){if(d.desktop&&zk.currentFocus!=d){d._fixEmptyMessage(true)}},200);return this.$supers("doBlur_",arguments)},doFocus_:function(c){if(!this.isDisabled()){jq(this.$n()).addClass(this.$s("focus"));var d=this.$n("inp");if(d&&d.value==this._emptyMessage){d.value=""}}return this.$supers("doFocus_",arguments)},doMouseOver_:function(c){var d=c.domTarget;if(jq(d).hasClass(this.$s("option"))){this._hliteOpt(d,true)}},doMouseOut_:function(c){var d=c.domTarget;if(jq(d).hasClass(this.$s("option-hover"))){this._hliteOpt(d,false)}},_hliteOpt:function(e,c){var f=this.$s("option-hover");if(c){var d=jq(this.$n("sel")).find("."+f)[0];if(d){jq(d).removeClass(f)}jq(e).addClass(f)}else{jq(e).removeClass(f)}},_doArrowDown:function(e,c){if(e=="up"){this._moveOptionFocus("prev")}else{if(e=="down"){this._moveOptionFocus("next")}else{var f=this.$n("inp"),g=zk(f).getSelectionRange(),d=jq(this.$n()).find("."+this.$s("item-focus"))[0];if(g[0]==0&&g[1]==0){if(e=="left"){this._moveLabelFocus(d,"prev")}else{if(e=="right"){if(d){c.stop()}this._moveLabelFocus(d,"next")}}}}}},_moveOptionFocus:function(e){var h=this.$n("sel"),i=jq(h),g=i.find("."+this.$s("option-hover"))[0],c,f=e=="next";if(f&&!this._open){this.setOpen(true,{sendOnOpen:true})}else{if(g){c=f?g.nextSibling:g.previousSibling}else{c=f?h.firstChild:!f?h.lastChild:null}if(c){while(c&&c.style.display=="none"){c=f?c.nextSibling:c.previousSibling}}var d=this.$n("pp");if(c){this._hliteOpt(c,true);zk(c).scrollIntoView(d);this._currentTop=d.scrollTop}else{if(g){this._hliteOpt(g,false);zk(g).scrollIntoView(d);this._currentTop=d.scrollTop}}}},_moveLabelFocus:function(d,c){var g=this.$s("item-focus"),e,f=c=="next";if(d){jq(d).removeClass(g);e=f?d.nextSibling:d.previousSibling;if(!f&&!e){e=d}else{if(f&&e==this.$n("inp")){e=null}}}else{if(!f){e=this.$n("inp").previousSibling}}if(e){jq(e).addClass(g)}},_deleteLabel:function(f,c){var g=this.$n("inp"),i=zk(g).getSelectionRange(),e;if(i[0]==0&&i[1]==0){var h=this.$s("item-focus");if(e=jq(this.$n()).find("."+h)[0]){var d=(e.previousSibling&&f=="backspace")?"prev":"next";this._moveLabelFocus(e,d);this._doDeselect(e,{sendOnSelect:true});c.stop();this._startFixDisplay()}else{if((e=g.previousSibling)&&f=="backspace"){jq(e).addClass(h)}}}},_removeLabelFocus:function(){var d=this.$s("item-focus"),c=jq(this.$n()).find("."+d)[0];if(c){jq(c).removeClass(d)}},_doEnterPressed:function(){var f,c,d;if(d=this.fixDisplay){clearTimeout(d)}this._fixDisplay();if(this._open){if((c=this.$n("empty"))&&jq(c).hasClass(this.$s("empty-creatable"))){this._fireOnSearch(this.$n("inp").value);if(this._open){this.setOpen(false,{sendOnOpen:true})}}else{if((f=jq(this.$n("sel")))&&(c=f.find("."+this.$s("option-hover"))[0])){var e=f.children();this._doSelect(c,{sendOnSelect:true});if(this._open){this.setOpen(false,{sendOnOpen:true})}}}}},doClick_:function(d){if(!this.isDisabled()){var h=d.domTarget,c=jq(h),g=this.$n("inp"),e=false;this._removeLabelFocus();if(g.value==this._emptyMessage){g.value=""}if(c.hasClass(this.$s("option"))){this._doSelect(h,{sendOnSelect:true});e=true;if(this._open){this.setOpen(false,{sendOnOpen:true,fixEmptyMessage:true})}}else{if(c.hasClass(this.$s("option-hover"))){this._fireOnSearch(g.value);if(this._open){this.setOpen(false,{sendOnOpen:true})}}else{var f=h,i=this.$s("item");if(c.hasClass(i)||(f=c.parent("."+i)[0])){jq(f).addClass(this.$s("item-focus"))}if(!this._open){this.setOpen(true,{sendOnOpen:true})}}}g.focus();if(e){d.stop()}this.$supers("doClick_",arguments)}},_doSelect:function(e,c){this._hliteOpt(e,false);var d=e.innerHTML;if(this._selItems.indexOf(d)==-1){this._createLabel(d);e.style.display="none";this._selItems.push(d);this._fixEmptyMessage(true);if(c&&c.sendOnSelect){if(!this._renderByServer){this.fireOnSelect()}else{this.selectSubModel(d)}}}},doSelect_:function(c){if(c.domTarget==this.$n()){c.stop({revoke:true})}this.$super("doSelect_",arguments)},_selectItemDirectly:function(c){if(this._selItems.indexOf(c)==-1){this._createLabel(c);this._selItems.push(c);this._fixEmptyMessage(true)}},_doDeselect:function(h,f){var g=jq(h).find("."+this.$s("item-content"))[0].innerHTML,e=this._getItemByValue(g),c=this._selItems,d=c.indexOf(g);if(this._open){this.setOpen(false,{sendOnOpen:true})}c.splice(d,1);if(e){e.style.display="block"}jq(h).remove();this._updatePopupPosition();if(f&&f.sendOnSelect){if(!this._renderByServer){this.fireOnSelect()}else{this.deselectSubModel(d)}}this._startFixDisplay()},_getItemByValue:function(f){var c=jq(this.$n("sel")).children(),e;for(var d=0;d<c.length;d++){if((e=c[d])&&e.innerHTML==f){return e}else{if(!e){return null}}}},_createLabel:function(f){var d=document.createElement("span"),e=document.createElement("div"),c=document.createElement("div"),g=document.createElement("i"),h=this;d.className=this.$s("item");e.innerHTML=f;e.className=this.$s("item-content");c.className=this.$s("button")+" "+this.$s("delete");g.className=this.$s("icon")+" z-icon-times";d.appendChild(e);d.appendChild(c);c.appendChild(g);jq(c).bind("click",function(){if(!h.isDisabled()){h.$n("inp").focus();h._doDeselect(d,{sendOnSelect:true})}});this.$n().insertBefore(d,this.$n("inp"))},_clearSelection:function(f){var h=this.$n(),e=this.$n("inp"),g,d;if(h){g=h.firstChild}while(g&&g!=e){d=g;g=g.nextSibling;this._doDeselect(d,f)}this._selItems.length=0},fireOnSelect:function(){var g=jq(this.$n("sel")).children(),l,e=[],c=this._selItems,d=-1,k;for(var h=0;h<g.length;h++){if(g[h].style.display=="none"){d=h;break}}for(var f=0;f<c.length;f++){for(var h=0;h<g.length;h++){if((k=g[h])&&k.innerHTML==c[f]){e.push(h);break}}}l={selected:e,min:d};this.fire("onSelect",l)},selectSubModel:function(f){var d=jq(this.$n("sel")).children(),c;for(var e=0;e<d.length;e++){if(d[e].innerHTML==f){c=e;break}}data={itemIdx:c,select:true};this.fire("onSelectSubModel",data)},deselectSubModel:function(c){data={itemIdx:c,select:false};this.fire("onSelectSubModel",data)},_fireOnSearch:function(d){var c={text:d};this.fire("onSearch",c)},_fireOnSearching:function(d){if(d){var c={text:d};this.fire("onSearching",c)}},onFloatUp:function(c){if(c.origin!=this){if(this._open){this.setOpen(false,{sendOnOpen:true,fixEmptyMessage:true})}this._removeLabelFocus()}},doKeyDown_:function(c){var d=c.keyCode;switch(d){case 8:this._deleteLabel("backspace",c);break;case 9:break;case 13:break;case 27:break;case 37:this._doArrowDown("left",c);break;case 38:this._doArrowDown("up");break;case 39:this._doArrowDown("right",c);break;case 40:this._doArrowDown("down");break;case 46:this._deleteLabel("del",c);break;default:if(!this._isSeparator(d)){this._updateInput(c);if(!this._open){this.setOpen(true,{sendOnOpen:true})}}else{c.stop()}}if(!(d==39||d==46||d==8||d==37)){this._removeLabelFocus()}},doKeyUp_:function(c){var e=c.keyCode,d={hliteFirst:true};switch(e){case 13:this._doEnterPressed();break;case 27:if(this._open){this.setOpen(false,{sendOnOpen:true})}this._fixEmptyMessage();break;default:if(this._isSeparator(e)){this._doEnterPressed()}else{this._fixInputWidth();if(e==38||e==40){d=null}if(!this._renderByServer){this._startFixDisplay(d)}}}if(!(e>=37&&e<=40||e==13||e==9)){b(this)}},_isSeparator:function(e){var d=this._separator,c=this._separatorCode;return(c&&c.indexOf(e)!=-1)||((e>=48&&e<=122)&&d&&d.toUpperCase().indexOf(String.fromCharCode(e))!=-1)},_updateInput:function(c){var d=this;if(!this.fixInputWidth){this.fixInputWidth=setTimeout(function(){if(d.$n()){d._fixInputWidth()}},100)}},setOpen:function(d,e){if(!this.isDisabled()){this._open=d}if(this.$n("pp")){var c=this.$n("pp");if(d){this.open(this.$n(),c,e)}else{this.close(c,e)}}},open:function(g,c,e){var f,d=c.style;this._fixsz(c);zk(c).makeVParent();this.setFloating_(true);this.setTopmost();f=jq(g).offset();d.left=f.left+"px";d.top=f.top+jq(g).outerHeight()+"px";d.zIndex=g.style.zIndex;zk(c).slideDown(this,{duration:100});this._startFixDisplay({hliteFirst:true});if(e&&e.sendOnOpen){this.fire("onOpen",{open:true})}},close:function(c,d){zk(c).undoVParent();this.setFloating_(false);c.style.display="none";if(d){if(d.sendOnOpen){this.fire("onOpen",{open:false})}if(d.fixEmptyMessage){this._fixEmptyMessage()}}if(this._renderByServer){this._clearListContent()}},_fixsz:function(c){var d=c.style,e=this._ppMaxHeight;d.height="auto";d.left="-10000px";d.display="block";d.visibility="hidden";if(jq(c).height()>e){d.height=e+"px"}d.display="none";d.visibility="visible"},_fixInputWidth:function(){var h=this.$n(),f=this.$n("inp"),g=this.$n("txcnt"),d=jq(h).height(),e,c=parseInt(this._width)-10;g.innerHTML=f.value;e=jq(g).width()+30;if(e>c){f.style.width=c+"px"}else{f.style.width=e+"px"}if(jq(h).height()!=d){this._updatePopupPosition(h,this.$n("pp"))}if(this.fixInputWidth){clearTimeout(this.fixInputWidth)}this.fixInputWidth=null},_startFixDisplay:function(d){if(d&&d.fromServer){this._fixDisplay(d)}else{var e=this,c;if(c=this.fixDisplay){clearTimeout(c)}this.fixDisplay=setTimeout(function(){if(e.$n()){e._fixDisplay(d);if(e._currentTop){e.$n("pp").scrollTop=e._currentTop}}},200)}},_fixDisplay:function(e){if(!this._open){return}var d=e&&e.fromServer;if(!this._renderByServer||d){var f=this.$n("inp").value,c=jq(this.$n("sel")).find("."+this.$s("option-hover"))[0],g=this._fixSelDisplay(e&&e.hliteFirst&&!c,f,d);f=f?f.trim():"";this._fixEmptyDisplay({showExistance:true},f,g._found,g._exist)}else{this._fixEmptyDisplay({showBlank:!this.$n("sel").firstChild})}},_fixSelDisplay:function(n,k,m){var d=this.$n("pp"),q=jq(d),g=this._ppMaxHeight,c=d.style,l=this._selItems,p=jq(this.$n("sel")).children(),o=false,j=false,i,h,e,f;k=k?k.trim():"";e=k&&k==this._emptyMessage||k=="";for(i=0,h=p[i];i<p.length;i++,h=p[i]){f=l.indexOf(h.innerHTML)!=-1;if(m||!f){if(!f&&(e||this._renderByServer||k&&h.innerHTML.toLowerCase().startsWith(k.toLowerCase()))){if(!o){o=true;if(n){this._hliteOpt(h,true)}}h.style.display="block"}else{this._hliteOpt(h,false);h.style.display="none"}}if(!j&&k&&h.innerHTML.toLowerCase()==k.toLowerCase()){j=true}}c.height="auto";if(q.height()>g){c.height=g+"px"}return{_found:o,_exist:j}},_fixEmptyDisplay:function(g,f,l,h){var e=this.$s("empty-creatable"),c=this.$n("empty");if(g&&(g.showBlank||g.showExistance&&this._renderByServer&&!f)){c.innerHTML="&nbsp;";jq(c).removeClass(e);c.style.display="block"}else{if(g&&g.showExistance){if(!l){if(this._creatable&&!h&&f){var j=this._createMessage,i=document.createElement("i");i.className=this.$s("icon")+" "+this.$s("create")+" z-icon-plus-square";if(j){j=zUtl.encodeXML(j.replace(/\{0\}/g,f)).replace(/\n/g,"<br />")}else{j="&nbsp;"}var k=document.createTextNode(j);c.innerHTML="";c.appendChild(k);c.insertBefore(i,k);jq(c).addClass(e)}else{var d=this._noResultsText;if(d){d=zUtl.encodeXML(d.replace(/\{0\}/g,f)).replace(/\n/g,"<br />")}else{d="&nbsp;"}c.innerHTML=d;jq(c).removeClass(e)}c.style.display="block"}else{c.style.display="none";jq(c).removeClass(e)}}}},_updatePopupPosition:function(){var e=this.$n(),c=this.$n("pp"),d=jq(e).offset();c.style.left=d.left+"px";c.style.top=d.top+jq(e).outerHeight()+"px"},_fixEmptyMessage:function(d){var c;if((!this._open||d)&&(c=this.$n("inp"))){c.value=this._selItems.length==0?zUtl.encodeXML(this.getEmptyMessage()):"";this._fixInputWidth();if(this._open){this._startFixDisplay()}}},domClass_:function(e){var d=this.$supers("domClass_",arguments),c=this.isDisabled()?this.$s("disabled"):"";return d+(d&&c?" ":"")+c},_getSearchingInterval:function(){return 350},onScroll:function(d){if(this._open){if(d){var c=this.getInputNode();if(c&&zul.inp.InputWidget._isInView(this)){zk(this.$n("pp")).position(c,"after_start")}else{this.setOpen(false,{sendOnOpen:true})}}}},getInputNode:_zkf=function(){return this.$n()}})})();