(function(){var j={};function e(m){m.stop()}function f(m){m.originalEvent.dataTransfer.dropEffect="copy"}function g(m){m.originalEvent.dataTransfer.dropEffect="none"}function i(m){e(m);f(m)}function h(m){e(m);g(m)}function a(){jq(document.body).bind("dragenter dragover",h)}function k(){jq(document.body).unbind("dragenter dragover",h)}function d(m){jq(document.body).bind("dragenter dragover",m.proxy(m._dragShow)).bind("dragleave",m.proxy(m._dragHide))}function l(m){jq(document.body).unbind("dragenter dragover",m.proxy(m._dragShow)).unbind("dragleave",m.proxy(m._dragHide))}zkmax.wgt.Dropupload=zk.$extends(zul.Widget,{_sid:0,_uploader:{},_detection:"browser",_content:"",_native:false,_anchorUuid:"",_last:{},setMaxsize:(function(m){return function(n){this[m]=n;return this}})("_maxsize"),getMaxsize:_zkf$=function(){return this._maxsize},isMaxsize:_zkf$,setViewerClass:(function(m){return function(n){this[m]=n;return this}})("_viewerClass"),getViewerClass:_zkf$=function(){return this._viewerClass},isViewerClass:_zkf$,setDetection:(function(m){return function(n){this[m]=n;return this}})("_detection"),getDetection:_zkf$=function(){return this._detection},isDetection:_zkf$,setContent:(function(m,n){return function(){this.__fname__=m.substring(1);this[m]=n.apply(this,arguments);delete this.__fname__;return this}})("_content",(function(m){return m?m:""})),getContent:_zkf$=function(){return this._content},isContent:_zkf$,setAnchorUuid:(function(m,n){return function(p,q){var r=this[m];this[m]=p;if(r!==p||(q&&q.force)){this.__fname__=m.substring(1);n.apply(this,arguments);delete this.__fname__}return this}})("_anchorUuid",(function(m){this._shallSyncSize=true})),getAnchorUuid:_zkf$=function(){return this._anchorUuid},isAnchorUuid:_zkf$,setNative:function(m){this._native=m},isNative:function(){return this._native},bind_:function(r,q,p){this.$supers("bind_",arguments);var o=this.getDetection(),m=jq(this.$n());m.bind("drop",this.proxy(this._dropAction));switch(o){case"self":m.bind("dragenter dragover",this.proxy(this._showContent)).bind("dragleave",this.proxy(this._hideContent));a();this._setContentVisible(false);break;case"browser":m.bind("dragenter dragover",f).bind("dragleave",g);d(this);this.hide();break;case"none":m.bind("dragenter dragover",i);a();break;default:var n=this;p.push(function(){var s=jq(n.$f(o));if(s.length){m.bind("dragenter dragover",i);s.bind("dragenter dragover",n.proxy(n._showContentNoneDrop)).bind("dragleave",n.proxy(n._hideContent));a();n._setContentVisible(false)}else{m.bind("dragenter dragover",f).bind("dragleave",g);d(n);n.hide()}})}},unbind_:function(){var n=this.getDetection(),m=jq(this.$n()).unbind("drop",this.proxy(this._dropAction));var o=jq(this.$f(n));if(n=="self"){m.unbind("dragenter dragover",this.proxy(this._showContent)).unbind("dragleave",this.proxy(this._hideContent));k()}else{if(n=="none"){m.unbind("dragenter dragover",i);k()}else{if(n=="browser"||!o.length){m.unbind("dragenter dragover",f).unbind("dragleave",g);l(this)}else{m.unbind("dragenter dragover",i);o.unbind("dragenter dragover",this.proxy(this._showContentNoneDrop)).unbind("dragleave",this.proxy(this._hideContent));k()}}}if(j[this.uuid]){delete j[this.uuid]}this.$supers("unbind_",arguments)},_showContent:function(m){i(m);this._setContentVisible(true);this._shallContentHide=false},_showContentNoneDrop:function(m){h(m);this._setContentVisible(true);this._shallContentHide=false},_hideContent:function(n){e(n);if(!this._shallContentHide){var m=this;setTimeout(function(){if(m&&m.desktop&&m._shallContentHide){m._setContentVisible(false)}},50)}this._shallContentHide=true},_setContentVisible:function(m){var n=jq(this.$n()).children();m?n.show():n.hide()},_dragHide:function(n){e(n);delete j[this.uuid];if(!this._shallHide){var m=this;setTimeout(function(){if(m&&m.desktop&&m._shallHide){m.setVisible(false)}},50)}this._shallHide=true},_dragShow:function(u){e(u);if(u.originalEvent.dataTransfer.dropEffect!="copy"){g(u)}this._shallHide=false;j[this.uuid]=this;var m=this.$n(),r=this._last,o=this._anchorUuid,w=0,s;for(s in r){if(r[s]){w++}}if(m&&this._shallSyncSize){if(o){m.style.position="fixed";m.style.zIndex="10000";var v=jq(o,zk),q=jq(m),p=v.offset(),t=q.offset();if(w==0){r.w=q.width()?q.width()+"px":"";r.h=q.height()?q.height()+"px":"";r.t=t.top?t.top+"px":"";r.l=t.left?t.left+"px":""}if(v.size()>0){m.style.width=v.width()+"px";m.style.height=v.height()+"px";m.style.top=p.top+"px";m.style.left=p.left+"px"}}else{m.style.position="stacic";m.style.zIndex="auto";m.style.width=r.w||"100px";m.style.height=r.h||"100px";m.style.top=r.t||"auto";m.style.left=r.l||"auto";this._last={}}this._shallSyncSize=false}this.setVisible(true)},_dropAction:function(t){e(t);for(var s in j){this._dragHide.call(j[s],t)}if(this.getDetection()=="self"){this._setContentVisible(false)}var p=t.originalEvent.dataTransfer.files;var m=this._maxsize>0?this._maxsize*1024:-1;if(m!=-1){var r=[];for(var o=0;o<p.length;o++){var n=p[o];if(n.size>m){r.push(n.name+" : "+Math.round(n.size/1024)+msgzk.KBYTES)}}if(r.length>0){jq.alert(r.join("\n")+"\nexceed "+this._maxsize+msgzk.KBYTES+" limit",{icon:"ERROR"});return}}for(var o=0;o<p.length;o++){this._sid++;var q=new zkmax.wgt.DropUploader(this,this._genKey(),p[o]);this._uploader[q.id]=q}this.checkFinish()},_genKey:function(){return this.uuid+"_uplder_"+this._sid},cancel:function(m){delete this._uploader[m];this.checkFinish()},checkFinish:function(){var m=false;for(var n in this._uploader){if(!(m=this._uploader[n].isFinish())){this._uploader[n].start();break}}if(m){this.fire("onUpload")}},domContent_:function(){return'<div id="'+this.uuid+'-content">'+this.getContent()+"</div>"}});function c(n){var m=zkmax.wgt.DropUploadViewer.fileManager;if(!m||!m.desktop){if(m){m.detach()}zkmax.wgt.DropUploadViewer.fileManager=m=new zkmax.wgt.DropUploadManager();n.getWidget().getPage().appendChild(m)}m.removeFile(n);m.addFile(n)}function b(m){if(zkmax.wgt.DropUploadManager){return c(m)}zk.load("zul.wgt,zul.box",function(){zkmax.wgt.DropUploadManager=zk.$extends(zul.wgt.Popup,{$init:function(){this.$supers("$init",arguments);this._files={};this.setSclass("z-fileupload-manager")},onFloatUp:function(n){if(!this.isVisible()){return}this.setTopmost()},getFileItem:function(n){return this._files[n]||zk.Widget.$(n)},addFile:function(p){var r=p.id,q=p.file.name,o=this.getFileItem(r);if(!o){o=new zul.wgt.Div({uuid:r,children:[new zul.wgt.Label({value:q+":"}),new zul.box.Box({mold:"horizontal",children:[new zkmax.wgt.Dropuploadprogress({id:r,sclass:"z-fileupload-progress"}),new zul.wgt.Div({sclass:"z-fileupload-remove z-icon-times",listeners:{onClick:function(){p.cancel()}}})]}),new zul.wgt.Label({id:r+"_total"}),new zul.wgt.Separator()]});try{this.appendChild(o)}catch(n){}this._files[r]=o}return o},updateFile:function(p,q,n){var r=p.id,o=this.getFileItem(r);if(!o){return}o.$f(r).setValue(q);o.$f(r+"_total").setValue(n)},removeFile:function(q){var s=q.id,o=this.getFileItem(s);if(o){o.detach()}delete this._files[s];var r=true;for(var n in this._files){if(!(r=false)){break}}if(r){this.close()}},open:function(o,n){this.$super("open",o,null,n||"after_start",{sendOnOpen:false,disableMask:true})}});c(m)})}zkmax.wgt.DropUploadViewer=zk.$extends(zk.Object,{$init:function(n,m){this.uploader=n;b(n)},update:function(m,n){var o=zkmax.wgt.DropUploadViewer.fileManager;if(o){if(!o.isOpen()){o.open(this.uploader.getWidget())}o.updateFile(this.uploader,m*100/n,msgzk.FILE_SIZE+Math.round(n/1024)+msgzk.KBYTES)}},destroy:function(){var m=zkmax.wgt.DropUploadViewer.fileManager;if(m){m.removeFile(this.uploader)}}});zkmax.wgt.DropUploader=zk.$extends(zk.Object,{_status:100,$init:function(n,q,o){this.upload=n;this.id=q;this.file=o;var p,m=this;if(n.getViewerClass()){zk.$import(n.getViewerClass(),function(r){p=new r(m,o)})}else{p=new zkmax.wgt.DropUploadViewer(this,o)}this.viewer=p;this.xhr=new XMLHttpRequest();this.xhr.upload.onprogress=this.progressFunc();this.xhr.onload=this.completeFunc()},getWidget:function(){return this.upload},isFinish:function(){return this._status==300},start:function(){if(this._status==200){return}this._status=200;var o=new FormData();o.append("file",this.file);var m=this.upload;var n=m.desktop;var q=zk.ajaxURI("/dropupload",{desktop:n,au:true})+"?uuid="+m.uuid+"&dtid="+n.id+"&maxsize="+m._maxsize+"&native="+m._native;var p=this.xhr;p.open("POST",q,true);p.send(o)},cancel:function(){if(this.xhr){this.xhr.abort()}this.viewer.destroy();this.upload.cancel(this.id)},progressFunc:function(){var m=this.viewer;return function(n){m.update(n.loaded,n.total)}},completeFunc:function(){var m=this;return function(n){m._status=300;m.viewer.destroy();m.upload.checkFinish()}}});zkmax.wgt.Dropuploadprogress=zk.$extends(zul.wgt.Progressmeter,{_fixImgWidth:_zkf=function(){var p=this.$n(),m=this.$n("img");if(m){if(zk(p).isRealVisible()){var o=jq(m)}o.animate({width:Math.round((p.clientWidth*this._value)/100)+"px"},o.zk.getAnimationSpeed(100))}}})})();