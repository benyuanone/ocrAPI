zul.wgt.Popup=zk.$extends(zul.Widget,{_visible:false,isOpen:function(){return this.isVisible()},open:function(f,h,b,e){var a=this._posInfo(f,h,b),d=this.$n(),g=d.style.top,c=jq(d);this._openInfo=arguments;this._shallToggle=e&&e.type=="toggle";c.css({position:"absolute"}).zk.makeVParent();zWatch.fire("onVParent",this);if(a){c.zk.position(a.dim,a.pos,e)}this.setFloating_(true);this.setTopmost();this.openAnima_(f,h,b,e)},openAnima_:function(c,d,a,b){this.afterOpenAnima_(c,d,a,b)},afterOpenAnima_:function(e,g,a,d){var c=this.$n();this.setVisible(true);if((!d||!d.disableMask)&&this.isListen("onOpen",{asapOnly:true})){if(this.mask){this.mask.destroy()}this.mask=new zk.eff.Mask({id:this.uuid+"-mask",anchor:c});zWatch.listen({onResponse:this})}if(this.shallStackup_()&&c){if(!this._stackup){this._stackup=jq.newStackup(c,c.id+"-stk")}else{var h,f;(h=this._stackup.style).top=(f=c.style).top;h.left=f.left;h.zIndex=f.zIndex;h.display="block"}}e=zk.Widget.$(e);if(d&&d.sendOnOpen){this.fire("onOpen",{open:true,reference:e})}jq(c).addClass(this.$s("open"));var b=this._openInfo;if(b){this.position.apply(this,b)}},shallStackup_:function(){return zk.eff.shallStackup()},position:function(d,e,b,c){var a=this._posInfo(d,e,b);if(a){zk(this.$n()).position(a.dim,a.pos,c)}},_posInfo:function(d,g,a,c){var h,f;if(a){if(d){if(typeof d=="string"){d=zk.Widget.$(d)}if(d){var e=zul.Widget.isInstance(d)?d.$n():d;if(e){h=a;f=zk(e).dimension(true)}else{return{pos:a}}}}else{return{pos:a}}}else{if(jq.isArray(g)){f={left:zk.parseInt(g[0]),top:zk.parseInt(g[1]),width:0,height:0}}}if(f){var b=zk(this.$n());f.top+=b.sumStyles("t",jq.margins);f.left+=b.sumStyles("l",jq.margins);return{pos:h,dim:f}}},onResponse:function(){if(this.mask){this.mask.destroy()}var a=this._openInfo;if(a){this.position.apply(this,a);this._openInfo=null}zWatch.unlisten({onResponse:this});this.mask=null},close:function(a){if(this._stackup){this._stackup.style.display="none"}this._shallToggle=false;this.closeAnima_(a)},closeAnima_:function(a){this.afterCloseAnima_(a)},afterCloseAnima_:function(c){this.setVisible(false);var b=this.$n();zk(b).undoVParent();zWatch.fireDown("onVParent",this);this.setFloating_(false);if(c&&c.sendOnOpen){this.fire("onOpen",{open:false})}if(zk.ie<11){var a=this;setTimeout(function(){a.replaceHTML(b)},50)}jq(b).removeClass(this.$s("open"))},onFloatUp:function(a,d){if(!this.isVisible()){return}var b=this._openInfo,c=a.args.length;if(this._shallToggle&&b&&d&&(d.triggerByClick===undefined||(b[3].which==d.triggerByClick&&zUtl.isAncestor(this._openInfo[0],a.origin)))){return}this._doFloatUp(a)},_doFloatUp:function(a){if(!this.isVisible()){return}var c=a.origin;for(var b;c;c=c.parent){if(c==this){if(!b){this.setTopmost()}return}if(c==this.parent&&c.ignoreDescendantFloatUp_(this)){return}b=b||c.isFloating_()}this.close({sendOnOpen:true})},onVParent:function(a){if(this._shallToggle){this._doFloatUp(a)}},bind_:function(){this.$supers(zul.wgt.Popup,"bind_",arguments);zWatch.listen({onFloatUp:this,onShow:this,onVParent:this});this.setFloating_(true)},unbind_:function(){zk(this.$n()).undoVParent();if(this._stackup){jq(this._stackup).remove();this._stackup=null}if(this._openInfo){this._openInfo=null}this._shallToggle=null;zWatch.unlisten({onFloatUp:this,onShow:this,onVParent:this});this.setFloating_(false);this.$supers(zul.wgt.Popup,"unbind_",arguments)},onShow:function(a){a.fire(this.firstChild);var b=this._openInfo;if(b){this.position.apply(this,b)}zk(this).redoCSS(-1,{fixFontIcon:true})},setHeight:function(a){this.$supers("setHeight",arguments);if(this.desktop){zUtl.fireShown(this)}},setWidth:function(a){this.$supers("setWidth",arguments);if(this.desktop){zWatch.fireDown("onShow",this)}},prologHTML_:function(a){},epilogHTML_:function(a){}});