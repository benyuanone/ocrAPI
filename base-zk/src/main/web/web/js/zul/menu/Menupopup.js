(function(){function c(j){var i=j.parent;return i.$instanceof(zul.menu.Menu)?i:null}function f(j){for(var i=j;i&&(i=c(i));i=i.parent){if(i.isTopmost()){return i}}return null}function e(i){return i.isVisible()&&(i.$instanceof(zul.menu.Menu)||(i.$instanceof(zul.menu.Menuitem)&&!i.isDisabled()))}function a(j,k){if(k){while(k=k.previousSibling){if(e(k)){j._curIndex--;return k}}}j._curIndex=-1;for(var i=j.firstChild;i;i=i.nextSibling){if(e(i)){k=i;j._curIndex++}}return k}function d(j,k){if(k){while(k=k.nextSibling){if(e(k)){j._curIndex++;return k}}}for(var i=j.firstChild;i;i=i.nextSibling){if(e(i)){j._curIndex=0;return i}}}function h(j,m){var k=-1;for(var l=j.firstChild;l;l=l.nextSibling){if(e(l)){k++}if(l==m){return k}}return k}function g(j){var m=j._curIndex;if(m>=0){for(var i=j.firstChild,l=0;i;i=i.nextSibling){if(e(i)&&l++==m){return i}}}}function b(j){var i=j.menupopup;if(i){i._shallClose=false;if(!i.isOpen()){i.open()}}j.$class._addActive(j);zWatch.fire("onFloatUp",j)}zul.menu.Menupopup=zk.$extends(zul.wgt.Popup,{_curIndex:-1,zsync:function(){this.$supers("zsync",arguments);if(!this._shadow){this._shadow=new zk.eff.Shadow(this.$n())}this._shadow.sync()},_hideShadow:function(){if(this._shadow){this._shadow.hide()}},_syncPos:function(){var i=c(this);if(i){var l=this.$n(),o=i.$n(),r=jq(l),s=jq(o),q=r.offset().left,p=s.offset().left,j=r.outerWidth(),v=s.outerWidth(),k=i.parent,t=i.getMenubar(),u=t?t.getOrient():"";if(i.isTopmost()&&u=="horizontal"&&l){l.style.top=jq.px0(zk.parseInt(l.style.top)+zk.parseInt(jq(this.getMenubar()).css("paddingBottom")))}while(k&&!k.$instanceof(zul.menu.Menupopup)){k=k.parent}if((zk(l).isOverlapped(o,1)&&(((p+v-q>5)&&(u!="vertical"))||((q<p+v/2)&&(u=="vertical"))))||(k&&k._shallSync)){this._shallSync=true;l.style.left=jq.px0(p-j);if(zk.ie){this.onShow()}}}},close:function(){if(this.isOpen()){zul.menu._nOpen--}this.$supers("close",arguments);jq(this.$n()).hide();this._hideShadow();var j;if((j=c(this))&&j.isTopmost()){jq(j.$n()).removeClass(j.$s("selected"))}var i=g(this);if(i){i.$class._rmActive(i)}this._curIndex=-1;this.$class._rmActive(this);this._shallSync=null},open:function(k,m,i,j){if(!this.isOpen()){zul.menu._nOpen++}var l;if(l=c(this)){if(!m){k=l.getAnchor_();if(!i){if(l.isTopmost()){i=l.parent.getOrient()=="vertical"?"end_before":"after_start"}else{i="end_before"}}}}this.$super("open",k,m,i,j||{sendOnOpen:true,disableMask:true});this._syncPos()},shallStackup_:function(){return false},setTopmost:function(){this.$supers("setTopmost",arguments);this.zsync()},onFloatUp:function(i,k){if(!this.isVisible()){return}var j=this._openInfo;if(this._shallToggle&&j&&k&&(k.triggerByClick===undefined||(j[3].which==k.triggerByClick&&zUtl.isAncestor(this._openInfo[0],i.origin)))){return}this._doFloatUp(i)},_doFloatUp:function(i){if(!this.isVisible()){return}var l=i.origin;if(this.parent.menupopup==this&&!this.parent.isTopmost()&&!this.parent.$class._isActive(this.parent)){this.close({sendOnOpen:true});return}for(var k,j=l;j;j=j.parent){if(j==this||(j.menupopup==this&&!this._shallClose)){if(!k){this.setTopmost()}return}k=k||j.isFloating_()}if(l&&l.ignoreDescendantFloatUp_(this)){for(var k,j=this;j=j.parent;){if(j==l){if(this._shallClose){break}if(!k){this.setTopmost()}return}k=k||j.isFloating_()}}this.close({sendOnOpen:true})},onShow:function(){this.zsync();var i=this.$n("a");if(i){if(zk(i).isRealVisible()){i.focus();zk.currentFocus=this}}zk(this).redoCSS(-1,{fixFontIcon:true})},onHide:function(){if(this.isOpen()){this.close()}this._hideShadow()},bind_:function(){this.$supers(zul.menu.Menupopup,"bind_",arguments);zWatch.listen({onHide:this,onResponse:this});var i=this.$n();this.domListen_(i,"onMouseEnter").domListen_(i,"onMouseLeave");if(!zk.css3){jq.onzsync(this)}},unbind_:function(){if(this.isOpen()){this.close()}if(this._shadow){this._shadow.destroy()}if(!zk.css3){jq.unzsync(this)}this._shadow=null;zWatch.unlisten({onHide:this,onResponse:this});var i=this.$n();this.domUnlisten_(i,"onMouseEnter").domUnlisten_(i,"onMouseLeave");this.$supers(zul.menu.Menupopup,"unbind_",arguments)},onResponse:function(){if(!this.isOpen()){return}this.zsync();this.$supers("onResponse",arguments);this._syncPos()},doKeyDown_:function(l){var k=g(this),o,n=l.keyCode;switch(n){case 38:case 40:if(k){k.$class._rmActive(k)}k=n==38?a(this,k):d(this,k);if(k){k.$class._addActive(k)}break;case 37:if(k&&k.$instanceof(zul.menu.Menu)&&k._contentHandler&&k._contentHandler.isOpen()){k._contentHandler.onHide()}else{if(((o=c(this)))&&!o.isTopmost()){this.close();o.$class._addActive(o);var j=o.parent;if(j){var m=j.$n("a");if(m){m.focus()}j._curIndex=h(j,o)}}else{var i=f(this);if(i&&(i=i._getPrevVisibleMenu())){b(i)}else{this.close()}}}break;case 39:if(k&&k.$instanceof(zul.menu.Menu)){k._togglePopup()}else{var i=f(this);if(i&&(i=i._getNextVisibleMenu())){b(i)}}break;case 13:if(k&&k.$instanceof(zul.menu.Menuitem)){k.doClick_(new zk.Event(k,"onClick",{}));zWatch.fire("onFloatUp",k);this.close({sendOnOpen:true})}else{if(k&&k.$instanceof(zul.menu.Menu)){k._togglePopup()}else{if((o=c(this))){this.close();if(o.isTopmost()){o.focus()}else{o.$class._addActive(o);var j=o.parent;if(j){var m=j.$n("a");if(m){m.focus()}}}}}}break;case 27:if((o=c(this))){if(o.isTopmost()){this.close();o.focus()}else{if(o._contentHandler&&o._contentHandler.isOpen()){content.onHide()}else{this.close();o.$class._addActive(o);var j=o.parent;if(j){var m=j.$n("a");if(m){m.focus()}}}}}break;case 9:var i=f(this);if(i){i.focus_(undefined,zk.ie<11)}this.close();break}if(n!=9){l.stop()}this.$supers("doKeyDown_",arguments)},getMenubar:function(){for(var i=this.parent;i;i=i.parent){if(i.$instanceof(zul.menu.Menubar)){return i}if(i.$instanceof(zul.menu.Menu)){return i.getMenubar()}break}return null},_doMouseEnter:function(i){var j=this.getMenubar();if(j){j._bOver=true}this._shallClose=false},_doMouseLeave:function(i){var j=this.getMenubar();if(j){j._bOver=false;if(j._autodrop){j._closeOnOut()}}}},{_rmActive:function(i){if(i.parent.$instanceof(zul.menu.Menu)){i.parent.$class._rmActive(i.parent)}}});zul.menu._nOpen=0})();