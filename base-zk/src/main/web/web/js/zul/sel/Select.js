zul.sel.Select=zk.$extends(zul.Widget,{_selectedIndex:-1,_rows:0,$init:function(){this.$supers("$init",arguments);this._selItems=[]},setMultiple:(function(a,b){return function(c,d){var e=this[a];this[a]=c;if(e!==c||(d&&d.force)){this.__fname__=a.substring(1);b.apply(this,arguments);delete this.__fname__}return this}})("_multiple",(function(a){var b=this.$n();if(b){b.multiple=a?"multiple":""}})),getMultiple:_zkf$=function(){return this._multiple},isMultiple:_zkf$,setDisabled:(function(a,b){return function(c,d){var e=this[a];this[a]=c;if(e!==c||(d&&d.force)){this.__fname__=a.substring(1);b.apply(this,arguments);delete this.__fname__}return this}})("_disabled",(function(a){var b=this.$n();if(b){b.disabled=a?"disabled":""}})),getDisabled:_zkf$=function(){return this._disabled},isDisabled:_zkf$,setSelectedIndex:(function(a,b){return function(c,d){var e=this[a];this[a]=c;if(e!==c||(d&&d.force)){this.__fname__=a.substring(1);b.apply(this,arguments);delete this.__fname__}return this}})("_selectedIndex",(function(a){var d=0,c=0,b,e=this.$n();this.clearSelection();for(b=this.firstChild;b&&d<a;b=b.nextSibling,d++){if(b.$instanceof(zul.sel.Option)){if(!b.isVisible()){c++}}else{d--}}a-=c;if(e){e.selectedIndex=a}if(a>-1&&b&&b.$instanceof(zul.sel.Option)){b.setSelected(true);this._selItems.push(b)}})),getSelectedIndex:_zkf$=function(){return this._selectedIndex},isSelectedIndex:_zkf$,setTabindex:(function(a,b){return function(c,d){var e=this[a];this[a]=c;if(e!==c||(d&&d.force)){this.__fname__=a.substring(1);b.apply(this,arguments);delete this.__fname__}return this}})("_tabindex",(function(a){var b=this.$n();if(b){b.tabindex=a||""}})),getTabindex:_zkf$=function(){return this._tabindex},isTabindex:_zkf$,setName:(function(a,b){return function(c,d){var e=this[a];this[a]=c;if(e!==c||(d&&d.force)){this.__fname__=a.substring(1);b.apply(this,arguments);delete this.__fname__}return this}})("_name",(function(a){var b=this.$n();if(b){b.name=a}})),getName:_zkf$=function(){return this._name},isName:_zkf$,setRows:(function(a,b){return function(c,d){var e=this[a];this[a]=c;if(e!==c||(d&&d.force)){this.__fname__=a.substring(1);b.apply(this,arguments);delete this.__fname__}return this}})("_rows",(function(a){var b=this.$n();if(b){b.size=a}})),getRows:_zkf$=function(){return this._rows},isRows:_zkf$,setMaxlength:(function(a,b){return function(c,d){var e=this[a];this[a]=c;if(e!==c||(d&&d.force)){this.__fname__=a.substring(1);b.apply(this,arguments);delete this.__fname__}return this}})("_maxlength",(function(a){if(this.desktop){this.rerender()}})),getMaxlength:_zkf$=function(){return this._maxlength},isMaxlength:_zkf$,setChgSel:function(f){var a={};for(var d=0;;){var c=f.indexOf(",",d),e=(c>=0?f.substring(d,c):f.substring(d)).trim();if(e){a[e]=true}if(c<0){break}d=c+1}for(var b=this.firstChild;b;b=b.nextSibling){this._changeSelect(b,a[b.uuid]==true)}},_changeSelect:function(b,a){var c=!!b.isSelected()!=a;if(c){b.setSelected(a)}return c},toggleItemSelection:function(a){if(a.isSelected()){this._removeItemFromSelection(a)}else{this._addItemToSelection(a)}},selectItem:function(a){if(!a){this.setSelectedIndex(-1)}else{if(this._multiple||!a.isSelected()){if(a.getOptionIndex_){this.setSelectedIndex(a.getOptionIndex_())}else{this.setSelectedIndex(a.getChildIndex())}}}},_addItemToSelection:function(b){if(!b.isSelected()){if(!this._multiple){this.selectItem(b)}else{var a=b.getOptionIndex_?b.getOptionIndex_():b.getChildIndex();if(a<this._selectedIndex||this._selectedIndex<0){this._selectedIndex=a}b._setSelectedDirectly(true);this._selItems.push(b)}}},_removeItemFromSelection:function(a){if(a.isSelected()){if(!this._multiple){this.clearSelection()}else{a._setSelectedDirectly(false);this._selItems.$remove(a)}}},clearSelection:function(){if(this._selItems.length){var a;for(;(a=this._selItems.pop());){a._setSelectedDirectly(false)}this._selectedIndex=-1}},domAttrs_:function(){var a;return this.$supers("domAttrs_",arguments)+(this.isDisabled()?' disabled="disabled"':"")+(this.isMultiple()?' multiple="multiple"':"")+((a=this.getSelectedIndex())>-1?' selectedIndex="'+a+'"':"")+((a=this.getTabindex())?' tabindex="'+a+'"':"")+((a=this.getRows())>0?' size="'+a+'"':"")+((a=this.getName())?' name="'+a+'"':"")},bind_:function(){this.$supers(zul.sel.Select,"bind_",arguments);var b=this.$n();this.domListen_(b,"onChange").domListen_(b,"onFocus","doFocus_").domListen_(b,"onBlur","doBlur_");if(!zk.gecko){var a=[this,this._fixSelIndex];zWatch.listen({onRestore:a,onVParent:a})}this._fixSelIndex()},unbind_:function(){var b=this.$n();this.domUnlisten_(b,"onChange").domUnlisten_(b,"onFocus","doFocus_").domUnlisten_(b,"onBlur","doBlur_").$supers(zul.sel.Select,"unbind_",arguments);var a=[this,this._fixSelIndex];zWatch.unlisten({onRestore:a,onVParent:a})},_fixSelIndex:function(){if(this._selectedIndex<0){this.$n().selectedIndex=-1}},_doChange:function(p){var i=[],f,e=this.$n();if(this._multiple){var a=e.options,h;for(var g=0,k=a.length;g<k;++g){var b=a[g],c=zk.Widget.$(b.id),m=b.selected;if(c&&c._selected!=m){c.setSelected(m);h=true}if(m){i.push(b.id);if(!f){f=b.id}}}if(!h){return}}else{var m=e.selectedIndex;if(zk.opera){e.selectedIndex=m}var d=m<0?m:-1;for(var l=this.firstChild,g=m;l&&g>-1;l=l.nextSibling){if(!l.$instanceof(zul.sel.Option)){continue}if(l.isVisible()){g--}d++}if(this._selectedIndex==d){return}this.setSelectedIndex(d);i.push(f=e.options[m].id)}this.fire("onSelect",{items:i,reference:f})},doBlur_:zk.ie8_?function(a){this._doChange(a);return this.$supers("doBlur_",arguments)}:zk.$void,beforeCtrlKeys_:function(a){this._doChange(a)},onChildAdded_:function(){this.rerender()},onChildRemoved_:function(){if(!this.childReplacing_){this.rerender()}}});