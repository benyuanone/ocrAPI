zul.mesh.SortWidget=zk.$extends(zul.mesh.HeaderWidget,{_sortDirection:"natural",_sortAscending:"none",_sortDescending:"none",setSortDirection:(function(a,b){return function(c,d){var e=this[a];this[a]=c;if(e!==c||(d&&d.force)){this.__fname__=a.substring(1);b.apply(this,arguments);delete this.__fname__}return this}})("_sortDirection",(function(a){if(this.desktop){var b=jq(this.$n("sort-icon"));b.removeClass();switch(a){case"ascending":b.addClass("z-icon-caret-up");break;case"descending":b.addClass("z-icon-caret-down")}}})),getSortDirection:_zkf$=function(){return this._sortDirection},isSortDirection:_zkf$,setSortAscending:(function(a,b){return function(c,d){var e=this[a];this[a]=c;if(e!==c||(d&&d.force)){this.__fname__=a.substring(1);b.apply(this,arguments);delete this.__fname__}return this}})("_sortAscending",(function(a){if(!a){this._sortAscending=a="none"}if(this.desktop){var b=jq(this.$n("sort-icon"));if(a=="none"){b.removeClass()}else{b.addClass("z-icon-caret-up")}}})),getSortAscending:_zkf$=function(){return this._sortAscending},isSortAscending:_zkf$,setSortDescending:(function(a,b){return function(c,d){var e=this[a];this[a]=c;if(e!==c||(d&&d.force)){this.__fname__=a.substring(1);b.apply(this,arguments);delete this.__fname__}return this}})("_sortDescending",(function(a){if(!a){this._sortDescending=a="none"}if(this.desktop){var b=jq(this.$n("sort-icon"));if(a=="none"){b.removeClass()}else{b.addClass("z-icon-caret-down")}}})),getSortDescending:_zkf$=function(){return this._sortDescending},isSortDescending:_zkf$,$init:function(){this.$supers("$init",arguments);this.listen({onSort:this},-1000)},setSort:function(a){if(a&&a.startsWith("client")){this.setSortAscending(a);this.setSortDescending(a)}else{this.setSortAscending("none");this.setSortDescending("none")}},isSortable_:function(){return this._sortAscending!="none"||this._sortDescending!="none"},sort:function(b,a){if(!this.checkClientSort_(b)){return false}a.stop();this.replaceCavedChildrenInOrder_(b);return true},checkClientSort_:function(b){var a=this.getSortDirection();if(b){if("ascending"==a){return false}}else{if("descending"==a){return false}}var d=b?this._sortAscending:this._sortDescending;if(d=="fromServer"){return false}else{if(d=="none"){evt.stop();return false}}var c=this.getMeshWidget();if(!c||c.isModel()){return false}return true},replaceCavedChildrenInOrder_:function(c){var a=this.getMeshWidget(),m=this.getMeshBody(),o=this.getSortDirection(),q=c?this._sortAscending:this._sortDescending,t=m.desktop,p=m.$n();try{m.unbind();var u=[],e=this.getChildIndex();for(var s=0,j=0,f=a.getBodyWidgetIterator(),l;(l=f.next());j++){for(var r=0,b=l.firstChild;b;b=b.nextSibling,r++){if(r==e){u[s++]={wgt:b,index:j}}}}var g=o=="ascending"?-1:1,h=this.sorting,n=q=="client(number)";u.sort(function(i,d){var k=h(i.wgt,d.wgt,n)*g;if(k==0){k=(i.index<d.index?-1:1)}return k});for(var s=0,r=u.length;s<r;s++){m.appendChild(u[s].wgt.parent)}this._fixDirection(c)}finally{m.replaceHTML(p,t)}},sorting:function(d,c,e){var g,f;if(typeof d.getLabel=="function"){g=d.getLabel()}else{if(typeof d.getValue=="function"){g=d.getValue()}else{g=d}}if(typeof c.getLabel=="function"){f=c.getLabel()}else{if(typeof c.getValue=="function"){f=c.getValue()}else{f=c}}if(e){return g-f}return g>f?1:(g<f?-1:0)},_fixDirection:function(b){var c=b?"ascending":"descending";for(var a=this.parent.firstChild;a;a=a.nextSibling){a.setSortDirection(a==this?c:"natural")}},onSort:function(a){var b=this.getSortDirection();if("ascending"==b){this.sort(false,a)}else{if("descending"==b){this.sort(true,a)}else{if(!this.sort(true,a)){this.sort(false,a)}}}},bind_:function(){this.$supers(zul.mesh.SortWidget,"bind_",arguments);if(this._sortAscending!="none"||this._sortDescending!="none"){var a=jq(this.$n()),b=jq(this.$n("sort-icon"));a.addClass(this.$s("sort"));switch(this._sortDirection){case"ascending":b.addClass("z-icon-caret-up");break;case"descending":b.addClass("z-icon-caret-down");break;default:break}}},unbind_:function(){this.$supers(zul.mesh.SortWidget,"unbind_",arguments)},getColumnMenuPopup_:zk.$void,_doMenuClick:function(h){if(this.parent._menupopup&&this.parent._menupopup!="none"){var b=this.parent._menupopup,a=this.$n("btn");jq(this.$n()).addClass(this.$s("visited"));if(b=="auto"&&this.parent._mpop){b=this.parent._mpop}else{b=this.$f(this.parent._menupopup)}if(zul.menu.Menupopup.isInstance(b)){var f=zk(a).revisedOffset(),g=this.getSortAscending()!="none",e=this.getSortDescending()!="none",i=this.getMeshWidget();if(b.$instanceof(zul.mesh.ColumnMenupopup)){b.getAscitem().setVisible(g);b.getDescitem().setVisible(e);var d=i.getModel();if(zk.feature.pe&&b.getGroupitem()){if(d=="group"||!d||this.isListen("onGroup",{asapOnly:1})){b.getGroupitem().setVisible((g||e))}else{b.getGroupitem().setVisible(false)}}if(zk.feature.ee&&b.getUngroupitem()){var c=!d||this.isListen("onUngroup",{asapOnly:1});b.getUngroupitem().setVisible(c&&i.hasGroup())}var j=b.getDescitem().nextSibling;if(j){j.setVisible((g||e))}}else{b.listen({onOpen:[this.parent,this.parent._onMenuPopup]})}b.open(a,[f[0],f[1]+a.offsetHeight-4],null,{sendOnOpen:true})}h.stop()}}});